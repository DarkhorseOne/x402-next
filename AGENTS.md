# Repository Guidelines

## Project Structure & Module Organization
- `src/index.ts` re-exports the public surface for consumers.
- `src/handlers/` contains wrappers for Next.js routing: `x402Route` (App Router) and `withX402` (Pages Router).
- `src/adapters/` provides request/response helpers that normalize Next.js primitives for `@darkhorseone/x402-core`.
- `src/errors/` is reserved for mapping errors to HTTP responses as integrations mature.
- `dist/` is generated by the build; avoid editing it directly.

## Build, Test, and Development Commands
- Minimum Next.js (CVE-2025-66478 patched): `15.0.5+` or `16.0.7+` (canary: `15.6.0-canary.58`, `16.1.0-canary.12`).
- `npm install` — install dependencies; peer dep `next` should be provided by the host app.
- Local x402-core (not published): run `npm install --no-save ../x402-core` or `npm link ../x402-core` before building/tests; remove/link-off when switching to a published version later.
- `npm run build` — compile TypeScript to `dist/` via `tsc -p tsconfig.json`.
- `npm test` — runs `vitest run` against the suites in `tests/`.

## Coding Style & Naming Conventions
- TypeScript throughout; keep 2-space indentation and trailing commas as in existing files.
- Classes: `PascalCase` (`NextRequestAdapter`, `NextResponseBuilder`); functions/hooks: `camelCase` (`x402Route`, `withX402`).
- Prefer explicit return types on exported functions and classes; keep handler signatures aligned with Next.js (App/Pages) expectations.
- No formatter is enforced yet; if you add one (e.g., Prettier/ESLint), apply it consistently across the repo.

## Testing Guidelines
- Vitest is the active runner; tests live in `tests/`.
- Cover happy path vs missing/invalid credentials (402) and network errors (503) for both routers.
- Include adapter/response builder shape checks so headers/status/payloads stay stable.

## Commit & Pull Request Guidelines
- Commit messages: short, imperative, and scoped (e.g., `add payment-required response builder`); keep related changes together.
- Pull requests should include: purpose/linked issue, summary of behavior changes, test results (or note absence), and any API surface changes.
- If you modify request/response shapes, note backwards compatibility and update docs/examples as needed.

## Security & Configuration Tips
- This package requires patched Next.js versions due to CVE-2025-66478 (React Server Components protocol); there is no workaround—upgrade before using.
- Do not commit secrets or sample credentials; rely on environment variables in consuming Next.js apps.
- When adding credential extraction, carefully handle headers/body parsing to avoid leaking sensitive data in logs or error messages.
